---
name: hetu-cloud-proto-backend-spec
description: "For hetu-cloud: 对原始原型需求/PRD（txt/md）做一致性检查与澄清，先产出《冲突说明（Q&A）》让用户逐条回答，再基于原始需求 + 回答整理生成偏后端的《需求说明》（数据模型、枚举、状态流转、校验规则、权限/锁定、接口清单、边界与 out-of-scope）。适用于原始需求冲突多、口径不统一、UI 描述多但后端规则缺失的场景。"
---

# Proto → Backend Spec（冲突澄清 + 后端需求说明）

## Goal

将“原始原型需求”整理成一份后端可直接开工的需求说明；在输出最终文档前，必须先输出一份可交互的冲突澄清 Q&A，让用户把关键口径一次性定死。

## Workflow

### 0) 收集输入（缺啥就问啥）

要求用户提供至少一份原始材料（直接粘贴也行）：

- 原始需求正文（txt/md）
- 可选：关键页面截图/交互描述（如果需求高度 UI 化）
- 可选：存量约束（数据库/枚举/接口兼容、权限模型、组织层级、术语表）

如果原文出现“实际是 / 跟方案一致 / 以 XX 为准”这种句子，直接当作“冲突候选”，必须进入 Q&A。

### 1) 只输出《冲突说明（Q&A）》

先阅读原始需求，做以下检查并转成问题：

- 冲突：同一规则在不同段落不一致
- 缺口：只讲 UI 操作，不讲后端规则/约束/边界
- 歧义：术语、对象、范围、状态含义不明确
- 风险：并发、幂等、唯一性、跨表校验、级联删除等未定义

输出要求：

- **本阶段只输出冲突 Q&A，不要输出最终后端需求说明。**
- 每个问题必须编号（Q1、Q2...），并包含：`问题`、`上下文/依据`、`为什么问（影响）`、`建议默认（可选）`、`你的回答（留空）`。
- 问题优先级：状态/权限/范围/唯一性/关联规则 > 字段细节 > UI 文案。

生成 Q&A 时，优先读取并按 `references/conflict-qa-template.md` 的结构输出。

### 1.5) 校验《冲突说明（Q&A）》是否已被回答（必须）

进入最终《后端需求说明》阶段前，先做一次“口径收敛”检查：

- 检查 Q&A 文档里是否仍存在空的 `你的回答：`（用户常说“我填完了”，但实际会漏 1-2 个）。
- 如存在空回答：
  - 优先：列出未回答的问题编号 + 问题一句话摘要，请用户补齐；
  - 备选：若用户明确同意“带 TBD 继续输出”，则把这些问题统一收敛到最终文档的 “未决项（TBD）”，并在相关章节标注 `TBD`。
- 若回答里出现“前端处理/后端不用管”：
  - 如果该点明确是 UI 纯交互/样式（例如按钮置灰、弹窗布局、前端校验提示样式），直接标注为 out-of-scope 即可，不需要在后端文档里展开；
  - 但如果该点会影响数据结构/接口契约/校验/删除策略/验收口径，必须追问或把回答转写成可落地结论（例如：后端仅透传字段、不落库、不校验、按某规则兜底等），不能一句“后端不用管”就糊过去。

### 2) 等用户回答后，输出《后端需求说明》

将“原始需求 + 用户回答”合并成一个逻辑闭环的后端说明，满足：

- 规则一致：所有冲突点有明确结论（或标注 TBD）
- 可落地：能直接拆接口/建表/写校验/写状态机
- 可验收：关键路径 + 禁止路径都有口径

生成后端说明时，优先读取并按 `references/backend-spec-template.md` 组织内容；建议在文档开头增加 “冲突 Q&A 结论汇总（Decision Log）”，把 Q1/Q2/... 的最终口径压缩成可落地结论并标注是否 TBD；输出前用 `references/backend-spec-checklist.md` 自检。

### 3) 输出规范（别糊弄）

- 把“默认假设/待确认（TBD）”集中列出来；不要把 TBD 藏在段落里。
- 对纯前端交互要求（按钮置灰、弹窗样式）标注为“前端行为/out-of-scope”，除非它影响后端权限/校验/状态。
- 不要编造不存在的字段/枚举/流程；缺口就问，或留 TBD。

## Resources

需要时读取：

- `references/conflict-qa-template.md`：冲突说明（Q&A）模板
- `references/backend-spec-template.md`：后端需求说明模板
- `references/backend-spec-checklist.md`：输出前自检清单
